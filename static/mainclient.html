<!DOCTYPE html>
<head>
<title>Pusher Test</title>
<link rel="stylesheet" type="text/css" href="static/style.css">
<script src="http://js.pusher.com/1.12/pusher.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script type="text/javascript" src="http://static.twilio.com/libs/twiliojs/1.0/twilio.min.js"></script>
<script type="text/javascript">

Pusher.channel_auth_endpoint = '/pusher2talk/pusherauth';

//Pusher Debug to print to log
//Pusher.log = function(message) {
//  if (window.console && window.console.log) {
//    window.console.log(message);
// }
//};


var pusher = new Pusher('c75e1662bedf930571b3');
var channel = pusher.subscribe("private-{{room}}");

function bind_event(){
	channel.bind('client-talk', function(data) {
			document.getElementById('talking').innerHTML = "Speaking:" + data.user;
			document.getElementById('ptt').style.visibility = 'hidden';
	   		}
	);
	channel.bind('client-stop', function(data) {
			document.getElementById('talking').innerHTML = "";
			document.getElementById('ptt').style.visibility = 'visible';
			 }
	);
	document.getElementById('room').innerHTML = "Channel: {{room}}";
	
}
function ptt_on(){		
	channel.trigger('client-talk', { "user" : "{{user}}" });
	conn.unmute()
	var sound = document.getElementById("sound1");
	sound.Play();
}

function ptt_off(){
  	channel.trigger('client-stop', { "user" : "{{user}}" });
	conn.mute()
	var sound = document.getElementById("sound1");
	sound.Play();
}


    Twilio.Device.setup('{{token}}');

    Twilio.Device.ready(function (device) {
        $("#log").text("Ready");
    });

    Twilio.Device.error(function (error) {
		console.log(error);
        $("#log").text("Error: " + error.message);
    });

    Twilio.Device.connect(function (conn) {
		console.log(conn.status);
        $("#log").text("Successfully established call");
    });

    Twilio.Device.disconnect(function (conn) {
		console.log(conn.status);
        $("#log").text("Call ended");
    });

    Twilio.Device.incoming(function (conn) {
        $("#log").text("Incoming connection from " + conn.parameters.From);
        // accept the incoming connection and start two-way audio
        conn.accept();
    });

var conn = Twilio.Device.connect({
		  room: "{{room}}",
		  user: "{{user}}"
		});

conn.mute()

</script>

</head>

<body onload="bind_event()">

<div id="room"></div><br>
<div id="talking"></div>
<button class="ptt" id="ptt" onmousedown="ptt_on()" onmouseup="ptt_off()">TALK</button>


<div id=log></div>
<embed src="static/chirp.mp3" autostart="false" width="0" height="0" id="sound1" enablejavascript="true">
</body> 
</html>